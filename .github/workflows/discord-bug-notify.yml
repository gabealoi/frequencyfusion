name: Notify Discord on Bug Issue

on:
  issues:
    types: [opened, reopened]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if the issue has the "bug" label
        if: contains(github.event.issue.labels.*.name, 'bug')
        run: |
          # Escape potential unwanted characters in issue title and user login
          TITLE="${{ github.event.issue.title }}"
          USER="${{ github.event.issue.user.login }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          REPO="${{ github.repository }}"

          # Escape the variables to handle special characters
          ESCAPED_TITLE=$(echo "$TITLE" | sed 's/"/\\"/g; s/\x27/\\x27/g')
          ESCAPED_USER=$(echo "$USER" | sed 's/"/\\"/g; s/\x27/\\x27/g')
          ESCAPED_REPO=$(echo "$REPO" | sed 's/"/\\"/g; s/\x27/\\x27/g')

          # Prepare the Discord message payload
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"# ðŸª²Bug Report:\n\n## Title: **[$ESCAPED_TITLE]($ISSUE_URL)**\n### Reported by: $ESCAPED_USER\n### Repository: [$ESCAPED_REPO](https://github.com/$ESCAPED_REPO)\"
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
